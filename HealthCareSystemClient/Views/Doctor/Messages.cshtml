@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_layoutDoctor";
    ViewData["Title"] = "Messages";
}

<div class="main-content">
    <partial name="_Header" />

    <div class="content">
        <div class="messages-layout">
            <div class="dashboard-card conversations-panel">
                <div class="card-header">
                    <h5 class="card-title">Patient Conversations</h5>
                    <button class="btn btn-sm btn-primary" onclick="startNewConversation()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="conversations-list" id="conversationsList">
                    <div class="text-center p-3 text-muted">Loading...</div>
                </div>
            </div>

            <div class="dashboard-card chat-panel">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-header" id="chatHeader" style="display: none;">
                        <div class="chat-doctor-info">
                            <img src="/placeholder.svg?height=48&width=48" alt="Patient" class="chat-avatar" id="chatAvatar">
                            <div class="chat-doctor-details">
                                <h6 id="chatPatientName">Patient Name</h6>
                                <p id="chatPatientInfo">Patient Info</p>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" onclick="startVideoCall()" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="chat-action-btn" onclick="viewPatientProfile()" title="View Profile">
                                <i class="fas fa-user"></i>
                            </button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="empty-chat">
                            <div class="empty-chat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h5>Select a conversation</h5>
                            <p>Choose a patient from the list to start messaging</p>
                        </div>
                    </div>

                    <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                        <form class="chat-input-form" onsubmit="sendMessage(event)">
                            <div class="chat-input-wrapper">
                                <input type="text" class="chat-input" id="messageInput" placeholder="Type your message...">
                                <button type="button" class="attachment-btn" onclick="attachFile()">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                            </div>
                            <button type="submit" class="send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="videoCallModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="background-color: #202124; border-radius: 15px; overflow: hidden; color: white;">

            <div class="modal-header border-0 py-2" style="background: rgba(0,0,0,0.3); position: absolute; top: 0; width: 100%; z-index: 10;">
                <h6 class="modal-title">
                    <i class="fas fa-video text-danger me-2"></i>
                    Call with <span id="videoCallPartnerName" class="fw-bold">Patient</span>
                </h6>
            </div>

            <div class="modal-body p-0 position-relative" style="height: 70vh; background: black;">

                <div id="video-loading" class="d-flex flex-column justify-content-center align-items-center h-100 w-100 position-absolute" style="z-index: 5; background: #202124;">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                    <h5 id="connectionStatus">Connecting...</h5>
                    <p class="text-muted small">Waiting for patient to join...</p>
                </div>

                <div id="remote-video" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;"></div>

                <div id="local-video" style="position: absolute; bottom: 20px; right: 20px; width: 200px; height: 150px; background: #333; border: 2px solid #fff; border-radius: 10px; overflow: hidden; z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.5);"></div>

                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4 d-flex gap-3" style="z-index: 20;">
                    <button class="btn btn-light rounded-circle p-3 shadow" onclick="toggleMute()" id="btnMute"><i class="fas fa-microphone"></i></button>
                    <button class="btn btn-light rounded-circle p-3 shadow" onclick="toggleVideo()" id="btnVideo"><i class="fas fa-video"></i></button>
                    <button class="btn btn-danger rounded-circle p-3 shadow px-4" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/microsoft/signalr/dist/browser/signalr.min.js"></script>
<script src="https://sdk.twilio.com/js/video/releases/2.27.0/twilio-video.min.js"></script>

<script>
    // Cấu hình AppConfig chuẩn
    window.AppConfig = {
        apiBaseUrl: '@(ViewBag.ApiBaseUrl ?? "https://localhost:7293")',
        userId: @(Context.Session.GetInt32("UserId") ?? 0),
        userToken: @Html.Raw(Json.Serialize(Context.Session.GetString("AccessToken") ?? "")),
        userEmail: @Html.Raw(Json.Serialize(Context.Session.GetString("Email") ?? "Doctor"))
    };
</script>

<script src="~/js/doctor/messages.js?v=@DateTime.Now.Ticks"></script>

<script>
    // Hiển thị tên bác sĩ
    document.addEventListener("DOMContentLoaded", function() {
        const nameEl = document.getElementById("headerDoctorName");
        if(nameEl && window.AppConfig.userEmail) {
            nameEl.innerText = "Dr. " + window.AppConfig.userEmail.split('@@')[0];
        }
    });
</script>